{% extends "dashboard.html" %}
{% block title %}View Report{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/view_report.css') }}" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
{% endblock %}

{% block content %}
<div class="view-report-page">
  <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
      <h1 class="page-title"><i class="fa-solid fa-chart-line"></i> Session Analytics</h1>
      <p class="page-subtitle">Detailed engagement and face analysis report for the session.</p>
    </div>
    <form action="{{ url_for('delete_report', session_id=session.id) }}" method="POST"
      onsubmit="return confirm('Are you sure you want to delete this report? This action cannot be undone.');">
      <button type="submit"
        style="background-color: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; gap: 8px; font-weight: 500; transition: background-color 0.2s ease;">
        <i class="fa-solid fa-trash"></i> Delete Report
      </button>
    </form>
  </div>

  <main class="view-report-content">

    <!-- Top Row: Session Details & Overall Engagement -->
    <div class="top-dashboard-row">
      <!-- Session Details Card -->
      <section class="report-card session-details">
        <h2><i class="fa-solid fa-circle-info"></i> Session Details</h2>
        <div class="detail-item">
          <span class="detail-label">Session Name</span>
          <span class="detail-value">{{ session.name }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Date</span>
          <span class="detail-value">{{ session.date }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Time</span>
          <span class="detail-value">{{ session.start_time }} - {{ session.end_time }}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Trainer ID</span>
          <span class="detail-value">{{ session.trainer_id }}</span>
        </div>
      </section>

      <!-- Overall Engagement Card -->
      <section class="report-card engagement-score">
        <h2><i class="fa-solid fa-ranking-star"></i> Overall Engagement Score</h2>
        <div class="engagement-score-display">
          <span class="overall-engagement-score">{{ overall_engagement_score | float | round(2) }} %</span>
        </div>

        <!-- Engagement Score Legend -->
        <div class="score-legend">
          <p>Legend</p>
          <ul>
            <li><span class="legend-dot excellent"></span> 90-100 (Excellent)</li>
            <li><span class="legend-dot good"></span> 70-89 (Good)</li>
            <li><span class="legend-dot average"></span> 50-69 (Avg)</li>
            <li><span class="legend-dot bad"></span> 30-49 (Bad)</li>
            <li><span class="legend-dot extremely-bad"></span> 0-29 (Poor)</li>
          </ul>
        </div>
      </section>
    </div> <!-- End Top Row -->

    <!-- Bottom Row: Engagement by Zone & Face Analysis Data -->
    <div class="bottom-dashboard-row">


      <!-- Engagement Score by Zone Card -->
      <section class="report-card engagement-analysis">
        <h2><i class="fa-solid fa-location-dot"></i> Engagement by Zone</h2>

        <div class="chart-container">
          {% if zone_chart_b64 %}
          <img src="data:image/png;base64,{{ zone_chart_b64 }}" alt="Engagement by Zone" class="small-chart">
          {% else %}
          <p>No chart data available.</p>
          {% endif %}
        </div>

        <p class="engzone-description">
          Distribution of engagement detected across different classroom zones.
        </p>

        <div class="data-table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Zone</th>
                <th>Score</th>
              </tr>
            </thead>
            <tbody>
              {% for row in engagement_df %}
              <tr>
                <td style="text-transform: capitalize;">{{ row.zone }}</td>
                <td>{{ row.engagement_score | float | round(1) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Face Analysis Data Card -->
      <section class="report-card face-analysis">
        <h2><i class="fa-solid fa-users-viewfinder"></i> Face Analysis Data</h2>

        <div class="chart-container">
          <!-- Annotated Output Image -->
          {% if annotated_image_b64 %}
          <img src="data:image/jpeg;base64,{{ annotated_image_b64 }}" alt="Annotated Image" class="small-chart">
          {% else %}
          <p>No annotated image available.</p>
          {% endif %}
        </div>

        <p class="emotion-description">
          Detected eye state and gaze direction for audience faces during the session.
        </p>

        <div class="data-table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Face ID</th>
                <th>Confidence</th>
                <th>Eye State</th>
                <th>Gaze</th>
                <th>Zone</th>
              </tr>
            </thead>
            <tbody>
              {% for face in face_data %}
              <tr>
                <td>{{ face.face_id }}</td>
                <td>{{ (face.detection_confidence | default(0)) | float | round(2) }}</td>
                <td style="text-transform: capitalize;">{{ face.eye_state | default('N/A') }}</td>
                <td style="text-transform: capitalize;">{{ face.gaze | default('N/A') }}</td>
                <td style="text-transform: capitalize;">{{ face.zone | default('N/A') }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

    </div> <!-- End Bottom Row -->

  </main>
</div>

<!-- JavaScript for charting (Using Chart.js) -->
<script>
  // Assuming the overall_engagement_score is available as a JavaScript variable
  var score = parseFloat("{{ overall_engagement_score | float }}");

  // Get the element to change its color
  var scoreElement = document.querySelector(".overall-engagement-score");

  // Determine the color based on the score value and apply it
  if (score >= 90) {
    scoreElement.style.color = "#4caf50"; // Excellent (green)
  } else if (score >= 70) {
    scoreElement.style.color = "#cfff99"; // Good (light green)
  } else if (score >= 50) {
    scoreElement.style.color = "#ffeb3b"; // Average (yellow)
  } else if (score >= 30) {
    scoreElement.style.color = "#ff9800"; // Bad (orange)
  } else {
    scoreElement.style.color = "#f44336"; // Extremely Bad (red)
  }
</script>
{% endblock %}